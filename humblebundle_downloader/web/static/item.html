<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Item Detail</title>
  <style>
    :root {
      --bg: #0c1220;
      --panel: rgba(255,255,255,0.05);
      --text: #f4f7ff;
      --muted: #9ab0d0;
      --accent: #46ffd6;
      --accent-2: #ffb347;
    }
    body { margin: 0; background: radial-gradient(circle at 20% 20%, #152341, #0c1220); color: var(--text); font-family: "Segoe UI", "Inter", system-ui, -apple-system, sans-serif; min-height: 100vh; }
    .page { max-width: 1100px; margin: 0 auto; padding: 32px 20px 72px; }
    .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .nav a { color: var(--text); text-decoration: none; font-weight: 700; }
    .nav .links { display: flex; gap: 14px; align-items: center; }
    .icon-link { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); color: var(--text); text-decoration: none; }
    .user-pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.14); font-size: 12px; }
    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); }
    .muted { color: var(--muted); }
    .btn { border: none; border-radius: 10px; padding: 10px 12px; background: linear-gradient(135deg, var(--accent), #39c0ff); color: #041325; font-weight: 700; cursor: pointer; box-shadow: 0 12px 30px rgba(70,255,214,0.25); }
    .meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 12px; margin-top: 12px; }
    .meta div { background: rgba(255,255,255,0.04); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); }
    a { color: var(--accent); }
    .hero { display: grid; grid-template-columns: 200px 1fr; gap: 16px; align-items: center; }
    .hero-left { display: flex; flex-direction: column; gap: 10px; }
    .hero img { width: 100%; border-radius: 12px; object-fit: cover; background: rgba(255,255,255,0.05); min-height: 200px; }
    .primary-download-wrap { display: flex; justify-content: flex-start; }
    @media (max-width: 720px) { .hero { grid-template-columns: 1fr; } }
    .tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .tag { padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); font-size: 12px; }
    .key-box { padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); margin-top: 8px; font-family: "SFMono-Regular", "Cascadia Code", monospace; }
    .variant-list { margin-top: 16px; display: grid; gap: 8px; }
    .variant { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="page">
    <div class="nav">
      <a href="/">Humble Library</a>
      <div class="links">
        <a href="/">Home</a>
        <a href="/library">Library</a>
        <a href="/admin">Control Room</a>
        <a class="icon-link" href="/settings">⚙ Settings</a>
        <span class="user-pill" id="userBadgeItem" style="display:none;"></span>
      </div>
    </div>
      <div class="panel">
        <p class="muted"><a href="/">Home</a> · <a href="/library">Library</a></p>
        <div class="hero">
          <img id="cover" alt="cover">
          <div>
            <h1 id="title">Item</h1>
            <p class="muted" id="subtitle"></p>
            <p id="desc" class="muted"></p>
          </div>
        </div>
        <div class="meta">
          <div><strong>Category</strong><br><span id="cat"></span></div>
          <div><strong>Platform</strong><br><span id="platform"></span></div>
          <div><strong>Ext</strong><br><span id="ext"></span></div>
          <div><strong>Size</strong><br><span id="size"></span></div>
        </div>
        <div style="margin-top:16px; display:grid; grid-template-columns: 1fr; gap: 12px; align-items:flex-start;">
          <div>
            <p><strong>File</strong><br><span id="file"></span></p>
            <p><strong>Status</strong><br><span id="status"></span></p>
            <div id="downloadUrls" style="margin-top:8px; display:none;">
              <p><strong>Download URLs</strong></p>
              <div class="key-box" id="downloadList"></div>
            </div>
            <div id="keyBox" style="display:none;">
              <p><strong>Activation key</strong></p>
              <div class="key-box" id="keyValue"></div>
            </div>
            <div><strong>Tags</strong><div class="tags" id="tags"></div></div>
          </div>
        </div>
        <div style="margin-top:16px;">
          <h3>Other downloads/variants for this product</h3>
          <div class="variant-list" id="variantList"><div class="muted">Loading...</div></div>
        </div>
      </div>
  </div>
  <script>
    async function loadItem() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;
      const res = await fetch(`/api/assets/${id}`);
      if (!res.ok) {
        document.getElementById('title').textContent = 'Not found';
        return;
      }
      const item = await res.json();
      document.getElementById('title').textContent = item.product_title || item.file_name || 'Item';
      document.getElementById('subtitle').textContent = item.bundle_title || '';
      const desc = item.description && item.description.trim() ? item.description.trim() : '';
      document.getElementById('desc').textContent = desc;
      const cover = document.getElementById('cover');
      if (item.image_url) {
        cover.src = item.image_url;
      } else {
        cover.style.display = 'none';
      }
      document.getElementById('cat').textContent = item.category || '-';
      document.getElementById('platform').textContent = item.platform || '-';
      document.getElementById('ext').textContent = item.ext || '-';
      document.getElementById('size').textContent = item.size_bytes ? `${Math.round(item.size_bytes/1024/1024)} MB` : '-';
      document.getElementById('file').textContent = item.file_name || '';
      document.getElementById('status').textContent = item.exists ? 'On disk' : 'Not found';
      const primary = document.getElementById('primaryDownload');
      if (item.exists) {
        primary.href = `/api/assets/${id}/file`;
        primary.style.opacity = '1';
        primary.style.pointerEvents = 'auto';
      } else {
        primary.href = '#';
        primary.style.opacity = '0.5';
        primary.style.pointerEvents = 'none';
      }
      if (item.activation_key) {
        document.getElementById('keyValue').textContent = item.activation_key;
        document.getElementById('keyBox').style.display = 'block';
      }
      await loadVariants(item);
      const tagsBox = document.getElementById('tags');
      tagsBox.innerHTML = '';
      if (item.tags) {
        const tags = item.tags.split(',').filter(Boolean);
        tags.forEach(t => {
          const el = document.createElement('span');
          el.className = 'tag';
          el.textContent = t;
          tagsBox.appendChild(el);
        });
      } else {
        tagsBox.innerHTML = '<span class="muted">No tags</span>';
      }
      fetch('/api/me').then(r => r.json()).then(d => {
        if (d.user) {
          const badge = document.getElementById('userBadgeItem');
          badge.style.display = 'inline-flex';
          badge.textContent = d.user;
        }
      }).catch(() => {});
    }

    async function loadVariants(item) {
      const list = document.getElementById('variantList');
      list.innerHTML = '<div class="muted">Loading...</div>';
      try {
        const url = new URL('/api/assets', window.location.origin);
        if (item.order_id) url.searchParams.set('order_id', item.order_id);
        if (item.product_title) url.searchParams.set('product', item.product_title);
        url.searchParams.set('limit', '200');
        const res = await fetch(url);
        if (!res.ok) {
          list.innerHTML = '<div class="muted">Failed to load variants.</div>';
          return;
        }
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) {
          list.innerHTML = '<div class="muted">No other entries for this product.</div>';
          return;
        }
        list.innerHTML = '';
        items.forEach(it => {
          let urls = [];
          if (Array.isArray(it.download_urls)) {
            urls = it.download_urls;
          } else if (typeof it.download_urls === 'string') {
            try {
              if (it.download_urls.trim().startsWith('[')) {
                urls = JSON.parse(it.download_urls);
              } else {
                urls = it.download_urls.split(',').filter(Boolean);
              }
            } catch (err) {
              urls = (it.download_urls || '').split(',').filter(Boolean);
            }
          }
          const status = it.downloaded ? 'Downloaded' : 'Not downloaded';
          let urlLinks = '';
          if (urls.length) {
            urlLinks = urls.map((u, idx) => {
              const label = idx === 0 ? 'Download from Humble Bundle' : 'Torrent from Humble Bundle';
              return `<div><a href="${u}">${label}</a></div>`;
            }).join('');
          }
          const links = [];
          links.push(it.exists
            ? `<a class="btn" href="/api/assets/${it.id}/file">Download cached</a>`
            : `<a class="btn" style="opacity:0.5; pointer-events:none;">Download cached</a>`);
          if (urlLinks) {
            links.push(urlLinks);
          }
          const link = links.join('<div style="height:4px;"></div>');
          const row = document.createElement('div');
          row.className = 'variant';
          row.innerHTML = `
            <div>
              <div><strong>${it.product_title || it.file_name || 'Item'}</strong></div>
              <div class="muted">${it.platform || 'n/a'} · ${it.ext || ''} · ${status}</div>
            </div>
            <div style="text-align:right; display:flex; gap:8px; align-items:center; justify-content:flex-end;">${link}</div>
          `;
          list.appendChild(row);
        });
      } catch (err) {
        list.innerHTML = `<div class="muted">Error: ${err}</div>`;
      }
    }

    loadItem();
  </script>
</body>
</html>
