<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Explorer</title>
  <style>
    :root {
      --bg: #0c1220;
      --panel: rgba(255,255,255,0.05);
      --text: #f4f7ff;
      --muted: #9ab0d0;
      --accent: #46ffd6;
      --accent-2: #ffb347;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, #142341, var(--bg));
      color: var(--text);
      font-family: "Segoe UI", "Inter", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }
    .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .nav a { color: var(--text); text-decoration: none; font-weight: 700; }
    .nav .links { display: flex; gap: 14px; align-items: center; }
    .page { max-width: 1220px; margin: 0 auto; padding: 32px 20px 72px; }
    .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .nav a { color: var(--text); text-decoration: none; font-weight: 700; }
    .nav .links { display: flex; gap: 14px; align-items: center; }
    h1 { margin: 0 0 8px; }
    .muted { color: var(--muted); }
    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 16px 0; }
    .input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
    }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      background: linear-gradient(135deg, var(--accent), #39c0ff);
      color: #041325;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(70,255,214,0.25);
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
    }
    .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); padding: 16px; margin-top: 12px; }
    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); text-align: left; }
    th { color: var(--muted); font-size: 12px; letter-spacing: 0.4px; }
    .badge { padding: 4px 8px; border-radius: 8px; background: rgba(70,255,214,0.12); border: 1px solid rgba(70,255,214,0.25); color: var(--accent); font-size: 12px; }
    .status-pill { padding: 4px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); font-size: 12px; display: inline-flex; gap: 6px; align-items: center; }
    .status-pill.good { border-color: rgba(70,255,214,0.4); color: var(--accent); }
    .status-pill.missing { border-color: rgba(255,179,71,0.5); color: var(--accent-2); }
    a { color: var(--accent); text-decoration: none; }
    .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; background: rgba(255,255,255,0.04); }
    tr:hover { background: rgba(255,255,255,0.04); cursor: pointer; }
    .icon-link { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); color: var(--text); text-decoration: none; }
    .user-pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.14); font-size: 12px; }
    td { word-break: break-word; }
    th:nth-child(1), td:nth-child(1) { width: 56px; }
    th:nth-child(2), td:nth-child(2) { width: 20%; }
    th:nth-child(3), td:nth-child(3) { width: 18%; }
    th:nth-child(4), td:nth-child(4) { width: 18%; }
    th:nth-child(5), td:nth-child(5) { width: 10%; }
    th:nth-child(6), td:nth-child(6) { width: 13%; }
    th:nth-child(7), td:nth-child(7) { width: 8%; }
    th:nth-child(8), td:nth-child(8) { width: 6%; }
    th:nth-child(9), td:nth-child(9) { width: 8%; }
  </style>
</head>
<body>
  <div class="page">
    <div class="nav">
        <a href="/">Humble Library</a>
        <div class="links">
          <a href="/">Home</a>
          <a href="/library">Library</a>
          <a href="/purchases">Purchases</a>
          <a href="/admin">Control Room</a>
          <a class="icon-link" href="/settings">⚙ Settings</a>
          <span class="user-pill" id="userBadgeLibrary" style="display:none;"></span>
        </div>
      </div>
    <h1>Library Explorer</h1>
    <p class="muted">Browse by category, platform, extension, or search. Downloaded-only is on by default to match Home highlights.</p>
    <div class="card">
      <div class="controls">
        <input class="input" id="searchInput" placeholder="Search" oninput="debouncedSearch()">
        <input class="input" id="bundleInput" placeholder="Bundle">
        <select id="categorySelect" class="input" onchange="fetchAssets()">
          <option value="">All categories</option>
          <option value="ebook">Ebook</option>
          <option value="comic">Comic</option>
          <option value="music">Music</option>
          <option value="sfx">SFX</option>
          <option value="audio">Audio (other)</option>
          <option value="tutorial">Tutorial</option>
          <option value="software">Software</option>
          <option value="android">Android</option>
          <option value="art">Art (general)</option>
          <option value="tileset">Tileset</option>
          <option value="sprites">Sprites</option>
          <option value="characters">Characters</option>
          <option value="ui">UI</option>
          <option value="3d">3D</option>
          <option value="rpg">RPG</option>
          <option value="rpg maker">RPG Maker</option>
          <option value="unity">Unity</option>
          <option value="unreal">Unreal</option>
          <option value="source">Source/Project</option>
          <option value="tool">Tool</option>
          <option value="key">Key/DLC</option>
          <option value="archive">Archive</option>
          <option value="other">Other</option>
        </select>
        <input class="input" id="bundleInput" placeholder="Bundle">
        <input class="input" id="platformInput" placeholder="Platform">
        <input class="input" id="extInput" placeholder="Extension (pdf, zip...)">
        <select id="sortSelect" class="input" onchange="fetchAssets()">
          <option value="recent">Newest</option>
          <option value="alpha">A → Z</option>
          <option value="bundle">By bundle</option>
        </select>
        <label class="toggle"><input type="checkbox" id="includeMissing" onchange="fetchAssets()"> Include not-downloaded</label>
        <button class="btn" onclick="fetchAssets()">Apply</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Product</th>
              <th>Bundle</th>
              <th>File</th>
              <th>Category</th>
              <th>Tags</th>
              <th>Platform</th>
              <th>Ext</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="assetTable"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    let searchTimer;

    function debouncedSearch() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(fetchAssets, 200);
    }

    async function fetchAssets() {
      const q = document.getElementById('searchInput').value.trim();
      const bundle = document.getElementById('bundleInput').value.trim();
      const platform = document.getElementById('platformInput').value.trim();
      const ext = document.getElementById('extInput').value.trim();
      const category = document.getElementById('categorySelect').value;
      const sort = document.getElementById('sortSelect').value;
      const includeMissing = document.getElementById('includeMissing').checked;
      const url = new URL('/api/assets', window.location.origin);
      if (q) url.searchParams.set('q', q);
      if (bundle) url.searchParams.set('bundle', bundle);
      const orderParam = new URLSearchParams(window.location.search).get('order');
      if (orderParam) url.searchParams.set('order_id', orderParam);
      if (platform) url.searchParams.set('platform', platform);
      if (ext) url.searchParams.set('ext', ext);
      if (category) url.searchParams.set('category', category);
      url.searchParams.set('sort', sort);
      if (!includeMissing) url.searchParams.set('downloaded', 'true');
      const res = await fetch(url);
      const data = await res.json();
      renderAssets(data.items);
    }

    function renderAssets(items) {
      const body = document.getElementById('assetTable');
      body.innerHTML = '';
      items.forEach((item) => {
        const tr = document.createElement('tr');
        tr.onclick = () => window.location.href = `/item?id=${item.id}`;
        const tags = (item.tags || '').split(',').filter(Boolean);
        const statusClass = item.downloaded ? 'good' : 'missing';
        const statusLabel = item.downloaded ? 'Downloaded' : 'Not downloaded';
        tr.innerHTML = `
          <td>${item.image_url ? `<img class="thumb" src="${item.image_url}" alt="">` : ''}</td>
          <td><a href="/item?id=${item.id}">${item.product_title || ''}</a></td>
          <td>${item.bundle_title || ''}</td>
          <td>${item.file_name || ''}</td>
          <td>${item.category || ''}</td>
          <td>${tags.map(t => `<span class="badge">${t}</span>`).join(' ')}</td>
          <td>${item.platform || ''}</td>
          <td>${item.ext || ''}</td>
          <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
        `;
        body.appendChild(tr);
      });
    }

    function applyPresetCategory() {
      const params = new URLSearchParams(window.location.search);
      const cat = params.get('category');
      const bundle = params.get('bundle');
      if (cat) {
        const catSelect = document.getElementById('categorySelect');
        if (catSelect) catSelect.value = cat;
      }
      if (bundle) {
        const bundleInput = document.getElementById('bundleInput');
        if (bundleInput) bundleInput.value = bundle;
      }
    }

    applyPresetCategory();
    fetchAssets();
    fetch('/api/me').then(r => r.json()).then(d => {
      if (d.user) {
        const badge = document.getElementById('userBadgeLibrary');
        badge.style.display = 'inline-flex';
        badge.textContent = d.user;
      }
    }).catch(() => {});
  </script>
</body>
</html>
